<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Miller Store - Viper Edition (Pro)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Rajdhani', 'sans-serif'] },
      colors: { dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155' } },
      animation: { 
        'marquee': 'marquee 25s linear infinite',
        'fade-in': 'fadeIn 0.3s ease-in',
        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite'
      },
      keyframes: { 
        marquee: { '0%': { transform: 'translateX(100%)' }, '100%': { transform: 'translateX(-100%)' } },
        fadeIn: { from: { opacity: 0 }, to: { opacity: 1 } }
      }
    }
  }
}
</script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">

<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/esc-pos-encoder@1.3.0/dist/esc-pos-encoder.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc, onSnapshot, query, orderBy, setDoc, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC_oCDI5CCJLBimBjWngn25xpZPUcE-y_8", // Ganti jika perlu
    authDomain: "millerstore1-e7bf8.firebaseapp.com",
    projectId: "millerstore1-e7bf8",
    storageBucket: "millerstore1-e7bf8.firebasestorage.app",
    messagingSenderId: "749437546306",
    appId: "1:749437546306:web:6632b2f145233f885222db",
    measurementId: "G-49SRT0VFQ6"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const googleProvider = new GoogleAuthProvider();

  window.fbOps = { 
    auth, db, googleProvider, signInWithPopup, signOut, onAuthStateChanged,
    collection, addDoc, getDocs, updateDoc, doc, deleteDoc, onSnapshot, query, orderBy, setDoc, where, serverTimestamp 
  };
</script>

<style>
  body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: white; }
  h1, h2, h3, .font-display { font-family: 'Rajdhani', sans-serif; }
  .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
  .glass-input { background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); color: white; }
  .glass-input:focus { border-color: #3b82f6; background: rgba(0, 0, 0, 0.5); }
  .hide-scroll::-webkit-scrollbar { display: none; }
  .safe-area-bottom { padding-bottom: calc(1rem + env(safe-area-inset-bottom)); }
</style>
</head>
<body class="touch-manipulation overflow-x-hidden selection:bg-blue-500 selection:text-white">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;
const { auth, db, googleProvider, signInWithPopup, signOut, onAuthStateChanged, collection, addDoc, updateDoc, doc, deleteDoc, onSnapshot, query, orderBy, setDoc, serverTimestamp } = window.fbOps;

// === ICONS ===
const Icon = ({ name, size = 20, className = "" }) => {
  const icons = {
    printer: <path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/>,
    bluetooth: <path d="M7 7l10 10-5 5V2l5 5L7 17"/>,
    trash: <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/>,
    check: <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>,
    plus: <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>,
    volumeOff: <path d="M11 5L6 9H2v6h4l5 4V5z"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/>,
    volumeOn: <path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M19.07 4.93a10 10 0 010 14.14"/><path d="M15.54 8.46a5 5 0 010 7.07"/>,
    newspaper: <path d="M4 22h16a2 2 0 002-2V4a2 2 0 00-2-2H8a2 2 0 00-2 2v16a2 2 0 01-2 2zm0 0a2 2 0 01-2-2v-9c0-1.1.9-2 2-2h2"/><path d="M18 14h-8"/><path d="M15 18h-5"/><path d="M10 6h8v4h-8V6z"/>,
    tag: <path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/>,
    user: <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/>,
    logOut: <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>,
    chevronLeft: <polyline points="15 18 9 12 15 6"/>
  };
  return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name]}</svg>;
};

// === PRINTER CLASS (BLUETOOTH) ===
class BluetoothPrinter {
  constructor() {
    this.device = null;
    this.characteristic = null;
    this.isConnected = false;
  }

  async connect() {
    if (!navigator.bluetooth) return alert("Browser tidak support Bluetooth Web!");
    try {
      this.device = await navigator.bluetooth.requestDevice({
        filters: [{ services: ['000018f0-0000-1000-8000-00805f9b34fb'] }]
      });
      const server = await this.device.gatt.connect();
      const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
      this.characteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
      this.isConnected = true;
      this.device.addEventListener('gattserverdisconnected', () => { this.isConnected = false; alert("Printer Terputus!"); });
      return true;
    } catch (e) {
      console.error(e);
      alert("Gagal konek: " + e.message);
      return false;
    }
  }

  async printReceipt(order) {
    if (!this.isConnected) return alert("Printer belum terkoneksi! Klik tombol Bluetooth di Admin.");
    try {
      const encoder = new EscPosEncoder();
      const date = new Date(order.createdAt).toLocaleString('id-ID');
      
      let bytes = encoder
        .initialize()
        .align('center')
        .bold(true).text('MILLER STORE').bold(false)
        .newline()
        .text('Top Up Games & Voucher')
        .newline()
        .text('--------------------------------')
        .newline()
        .align('left')
        .text(`Waktu : ${date}`)
        .newline()
        .text(`No Ref: ${order.id.slice(0,6).toUpperCase()}`)
        .newline()
        .text('--------------------------------')
        .newline()
        .bold(true).text('DETAIL PESANAN').bold(false)
        .newline()
        .text(`Game  : ${order.game}`)
        .newline()
        .text(`Item  : ${order.item}`)
        .newline()
        .text(`ID    : ${order.userId} (${order.zoneId})`)
        .newline()
        .text(`Nick  : ${order.inGameName}`)
        .newline()
        .text('--------------------------------')
        .newline()
        .align('right')
        .text(`Harga : Rp ${order.basePrice.toLocaleString()}`)
        .newline()
        .text(`Diskon: - Rp ${(order.basePrice - order.price).toLocaleString()}`)
        .newline()
        .bold(true).size(1,1).text(`TOTAL : Rp ${order.price.toLocaleString()}`).size(0,0).bold(false)
        .newline()
        .align('center')
        .text('--------------------------------')
        .newline()
        .text(`Status: ${order.status.toUpperCase()}`)
        .newline()
        .text(`Metode: ${order.paymentMethod.toUpperCase()}`)
        .newline()
        .newline()
        .text('* Simpan struk ini sebagai bukti *')
        .newline()
        .newline()
        .newline() 
        .encode();

      const chunkSize = 100; // Chunking untuk mencegah buffer overflow
      for (let i = 0; i < bytes.length; i += chunkSize) {
        await this.characteristic.writeValue(new Uint8Array(bytes.slice(i, i + chunkSize)));
        await new Promise(r => setTimeout(r, 50));
      }
      return true;
    } catch (e) {
      alert("Error Print: " + e.message);
      return false;
    }
  }
}

const printer = new BluetoothPrinter();

// === APP COMPONENT ===
function App() {
  const [user, setUser] = useState(null);
  const [isAdmin, setIsAdmin] = useState(false);
  const [view, setView] = useState('loading');
  
  // Data
  const [products, setProducts] = useState([]);
  const [orders, setOrders] = useState([]);
  const [news, setNews] = useState([]);
  const [promos, setPromos] = useState([]);
  const [config, setConfig] = useState({ banner: "Selamat Datang di Miller Store", videoUrl: "https://assets.mixkit.co/videos/preview/mixkit-gaming-world-concept-1-27829-large.mp4" });

  // UI State
  const [selectedGame, setSelectedGame] = useState(null);
  const [selectedItem, setSelectedItem] = useState(null);
  const [form, setForm] = useState({ uid: '', zone: '', nick: '', promo: '' });
  const [appliedPromo, setAppliedPromo] = useState(null);
  const [isMuted, setIsMuted] = useState(true);
  const [newsModal, setNewsModal] = useState(null);
  
  // Admin State
  const [adminTab, setAdminTab] = useState('orders');
  const [printerReady, setPrinterReady] = useState(false);
  const [autoPrint, setAutoPrint] = useState(false);
  const [newPromo, setNewPromo] = useState({ code: '', discount: 0 });
  const [newNews, setNewNews] = useState({ title: '', content: '' });

  // === REALTIME LISTENERS ===
  useEffect(() => {
    const unsubAuth = onAuthStateChanged(auth, (u) => {
      setUser(u);
      if (u) {
        // Cek Admin Email (Ganti dengan email admin kamu)
        const admins = ["millertevestipak@gmail.com", "admin@millerstore.com"]; 
        if (admins.includes(u.email)) {
          setIsAdmin(true);
          setView('admin');
        } else {
          setView('store');
        }
      } else {
        setView('login');
      }
    });

    // Listen Orders (dengan logika Auto Print)
    const qOrder = query(collection(db, "orders"), orderBy("createdAt", "desc"));
    const unsubOrder = onSnapshot(qOrder, (snap) => {
      let newOrders = [];
      let isInitialLoad = orders.length === 0;
      
      snap.docChanges().forEach((change) => {
        const orderData = { id: change.doc.id, ...change.doc.data() };
        if (change.type === "added") {
          newOrders.push(orderData);
          // Logika Auto Print: Hanya jika Auto Print ON, Printer Konek, dan Order Baru (< 1 menit)
          if (!isInitialLoad && autoPrint && printer.isConnected) {
            const orderTime = new Date(orderData.createdAt).getTime();
            const now = new Date().getTime();
            if (now - orderTime < 60000) { // Cek jika order kurang dari 1 menit yang lalu
              printer.printReceipt(orderData);
            }
          }
        }
      });
      
      // Update state full orders
      setOrders(snap.docs.map(d => ({id: d.id, ...d.data()})));
    });

    const unsubProd = onSnapshot(collection(db, "products"), (s) => setProducts(s.docs.map(d=>({id: d.id, ...d.data()}))));
    const unsubNews = onSnapshot(collection(db, "news"), (s) => setNews(s.docs.map(d=>({id: d.id, ...d.data()}))));
    const unsubPromo = onSnapshot(collection(db, "promos"), (s) => setPromos(s.docs.map(d=>({id: d.id, ...d.data()}))));
    
    return () => { unsubAuth(); unsubOrder(); unsubProd(); unsubNews(); unsubPromo(); };
  }, [autoPrint]); // Re-run effect jika toggle autoPrint berubah

  // === FUNGSI LOGIKA ===
  const handleLogin = async () => { try { await signInWithPopup(auth, googleProvider); } catch(e){ alert(e.message) } };
  const handleLogout = async () => { if(confirm("Keluar?")) await signOut(auth); };

  const checkPromo = () => {
    const code = form.promo.toUpperCase();
    const found = promos.find(p => p.code === code);
    if (found) {
      setAppliedPromo(found);
      alert(`Promo ${found.code} dipakai! Diskon Rp ${found.discount.toLocaleString()}`);
    } else {
      setAppliedPromo(null);
      alert("Kode Promo Salah!");
    }
  };

  const handleOrder = async () => {
    if(!form.uid || !form.nick) return alert("Lengkapi UID dan Nickname!");
    
    const finalPrice = appliedPromo ? (selectedItem.price - appliedPromo.discount) : selectedItem.price;
    
    const orderData = {
      game: selectedGame.title,
      item: selectedItem.name,
      basePrice: selectedItem.price,
      price: Math.max(0, finalPrice), // Harga tidak boleh minus
      userId: form.uid,
      zoneId: form.zone || '-',
      inGameName: form.nick,
      paymentMethod: 'qris',
      promoCode: appliedPromo ? appliedPromo.code : '-',
      status: 'pending',
      createdAt: new Date().toISOString(),
      customerName: user.displayName,
      email: user.email
    };

    await addDoc(collection(db, "orders"), orderData);
    alert("Pesanan Dibuat! Silahkan Scan QRIS.");
    setForm({ uid: '', zone: '', nick: '', promo: '' });
    setAppliedPromo(null);
    setSelectedGame(null);
  };

  // === ADMIN ACTIONS ===
  const togglePrinter = async () => {
    const connected = await printer.connect();
    setPrinterReady(connected);
  };

  const addPromo = async () => {
    if(!newPromo.code) return;
    await addDoc(collection(db, "promos"), { code: newPromo.code.toUpperCase(), discount: Number(newPromo.discount) });
    setNewPromo({ code: '', discount: 0 });
  };

  const addNews = async () => {
    if(!newNews.title) return;
    await addDoc(collection(db, "news"), newNews);
    setNewNews({ title: '', content: '' });
  };

  // === RENDERING ===
  if (view === 'loading') return <div className="h-screen bg-dark-900 flex items-center justify-center text-blue-500">Loading Viper...</div>;

  // VIEW: LOGIN
  if (view === 'login') return (
    <div className="h-screen bg-dark-900 flex flex-col items-center justify-center p-6 relative overflow-hidden">
      <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20"></div>
      <div className="glass-panel p-8 rounded-3xl text-center max-w-sm w-full z-10 shadow-2xl border border-blue-500/30">
        <h1 className="text-4xl font-black font-display mb-2">MILLER<span className="text-blue-500">STORE</span></h1>
        <p className="text-gray-400 mb-8 text-sm">Viper Edition Login</p>
        <button onClick={handleLogin} className="w-full bg-white text-black font-bold py-3 rounded-xl flex items-center justify-center gap-2 hover:scale-105 transition">
          <img src="https://www.google.com/favicon.ico" width="20"/> Masuk dengan Google
        </button>
      </div>
    </div>
  );

  // VIEW: ADMIN
  if (view === 'admin') return (
    <div className="min-h-screen bg-dark-900 text-gray-200 p-4 pb-20">
      <div className="flex justify-between items-center mb-6 glass-panel p-4 rounded-xl sticky top-0 z-50 bg-dark-900/90 backdrop-blur-md">
        <div>
          <h1 className="font-bold text-blue-400 font-display text-xl">ADMIN VIPER</h1>
          <div className="flex items-center gap-2 text-[10px] mt-1">
            <span className={printerReady ? "text-green-400" : "text-red-400"}>● Printer {printerReady ? "Connected" : "Off"}</span>
            <span className={autoPrint ? "text-green-400" : "text-gray-500"}>● AutoPrint {autoPrint ? "ON" : "OFF"}</span>
          </div>
        </div>
        <div className="flex gap-2">
          <button onClick={() => setAutoPrint(!autoPrint)} className={`p-2 rounded-lg text-xs font-bold ${autoPrint ? 'bg-green-600' : 'bg-gray-700'}`}>
            Auto {autoPrint ? 'ON' : 'OFF'}
          </button>
          <button onClick={togglePrinter} className={`p-2 rounded-lg ${printerReady ? 'bg-blue-600' : 'bg-gray-700'}`}>
            <Icon name="printer" size={18}/>
          </button>
          <button onClick={() => setView('store')} className="bg-white/10 p-2 rounded-lg text-xs">Toko</button>
        </div>
      </div>

      {/* Tabs */}
      <div className="flex gap-2 mb-4 overflow-x-auto hide-scroll">
        {['orders', 'promos', 'news'].map(t => (
          <button key={t} onClick={()=>setAdminTab(t)} className={`px-4 py-2 rounded-lg text-xs font-bold uppercase ${adminTab===t ? 'bg-blue-600' : 'bg-white/5'}`}>{t}</button>
        ))}
      </div>

      {/* ADMIN: ORDERS TAB */}
      {adminTab === 'orders' && (
        <div className="space-y-3">
          {orders.map(o => (
            <div key={o.id} className="glass-panel p-3 rounded-xl relative overflow-hidden">
              <div className="flex justify-between items-start mb-2">
                <div>
                  <div className="text-xs font-bold text-white">{o.item} ({o.game})</div>
                  <div className="text-[10px] text-gray-400">{o.customerName} • {new Date(o.createdAt).toLocaleTimeString()}</div>
                </div>
                <div className={`text-[10px] px-2 py-1 rounded font-bold ${o.status==='success'?'bg-green-500/20 text-green-400':'bg-yellow-500/20 text-yellow-400'}`}>
                  {o.status.toUpperCase()}
                </div>
              </div>
              <div className="bg-black/20 p-2 rounded text-[10px] font-mono mb-2">
                ID: {o.userId} ({o.zoneId})<br/>
                Nick: {o.inGameName}<br/>
                Promo: {o.promoCode}
              </div>
              <div className="flex justify-between items-center">
                <div className="font-bold text-blue-400">Rp {o.price.toLocaleString()}</div>
                <div className="flex gap-2">
                  <button onClick={()=>printer.printReceipt(o)} className="bg-purple-600 p-2 rounded text-xs flex items-center gap-1">
                    <Icon name="printer" size={14}/> Print
                  </button>
                  {o.status !== 'success' && (
                    <button onClick={()=>updateDoc(doc(db,"orders",o.id),{status:'success'})} className="bg-green-600 p-2 rounded text-xs">
                      <Icon name="check" size={14}/>
                    </button>
                  )}
                  <button onClick={()=>deleteDoc(doc(db,"orders",o.id))} className="bg-red-600/50 p-2 rounded text-xs">
                    <Icon name="trash" size={14}/>
                  </button>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* ADMIN: PROMOS TAB */}
      {adminTab === 'promos' && (
        <div className="space-y-4">
          <div className="glass-panel p-4 rounded-xl">
            <h3 className="text-sm font-bold mb-2">Tambah Kode Promo</h3>
            <div className="flex gap-2 mb-2">
              <input value={newPromo.code} onChange={e=>setNewPromo({...newPromo, code: e.target.value})} placeholder="Kode (Misal: VIPER)" className="glass-input flex-1 p-2 rounded text-xs uppercase"/>
              <input type="number" value={newPromo.discount} onChange={e=>setNewPromo({...newPromo, discount: e.target.value})} placeholder="Diskon (Rp)" className="glass-input w-24 p-2 rounded text-xs"/>
            </div>
            <button onClick={addPromo} className="w-full bg-blue-600 py-2 rounded text-xs font-bold">SIMPAN PROMO</button>
          </div>
          <div className="space-y-2">
            {promos.map(p => (
              <div key={p.id} className="bg-white/5 p-3 rounded-lg flex justify-between items-center">
                <div>
                  <div className="font-bold text-yellow-400">{p.code}</div>
                  <div className="text-xs text-gray-400">Potongan: Rp {p.discount.toLocaleString()}</div>
                </div>
                <button onClick={()=>deleteDoc(doc(db,"promos",p.id))} className="text-red-400"><Icon name="trash" size={16}/></button>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* ADMIN: NEWS TAB */}
      {adminTab === 'news' && (
        <div className="space-y-4">
          <div className="glass-panel p-4 rounded-xl">
            <h3 className="text-sm font-bold mb-2">Tambah Berita</h3>
            <input value={newNews.title} onChange={e=>setNewNews({...newNews, title: e.target.value})} placeholder="Judul Singkat (Running Text)" className="glass-input w-full p-2 rounded text-xs mb-2"/>
            <textarea value={newNews.content} onChange={e=>setNewNews({...newNews, content: e.target.value})} placeholder="Isi Berita Lengkap..." className="glass-input w-full p-2 rounded text-xs h-20 mb-2"></textarea>
            <button onClick={addNews} className="w-full bg-blue-600 py-2 rounded text-xs font-bold">POST BERITA</button>
          </div>
          <div className="space-y-2">
            {news.map(n => (
              <div key={n.id} className="bg-white/5 p-3 rounded-lg">
                <div className="flex justify-between">
                  <span className="font-bold text-xs">{n.title}</span>
                  <button onClick={()=>deleteDoc(doc(db,"news",n.id))} className="text-red-400"><Icon name="trash" size={14}/></button>
                </div>
                <p className="text-[10px] text-gray-400 truncate mt-1">{n.content}</p>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );

  // VIEW: STORE (USER)
  return (
    <div className="min-h-screen bg-dark-900 text-white pb-24 font-sans relative">
      {/* Navbar User */}
      <div className="absolute top-0 w-full z-30 p-4 flex justify-between items-center bg-gradient-to-b from-black/80 to-transparent">
        <h1 className="font-display font-black text-xl tracking-wider">MILLER<span className="text-blue-500">STORE</span></h1>
        <div className="flex gap-3 items-center">
          <span className="text-xs font-bold bg-white/10 px-3 py-1 rounded-full border border-white/10">Hi, {user?.displayName.split(' ')[0]}</span>
          <button onClick={handleLogout} className="bg-red-500/20 p-2 rounded-full"><Icon name="logOut" size={16}/></button>
        </div>
      </div>

      {/* Hero Video Banner */}
      <div className="relative h-64 w-full overflow-hidden rounded-b-[2rem] shadow-2xl">
        <video 
          src={config.videoUrl} 
          autoPlay 
          loop 
          muted={isMuted} // Mengontrol suara
          className="w-full h-full object-cover"
        ></video>
        <div className="absolute inset-0 bg-gradient-to-t from-dark-900 via-transparent to-black/30"></div>
        
        {/* Tombol Mute/Unmute */}
        <button 
          onClick={() => setIsMuted(!isMuted)} 
          className="absolute bottom-6 right-6 bg-black/50 backdrop-blur-md p-2 rounded-full border border-white/20 hover:bg-white/20 transition"
        >
          <Icon name={isMuted ? "volumeOff" : "volumeOn"} size={20} className="text-white"/>
        </button>
      </div>

      {/* Running Text Berita */}
      <div className="bg-black/40 border-y border-white/5 py-2 relative overflow-hidden backdrop-blur-sm -mt-4 z-20 mx-4 rounded-xl">
        <div className="whitespace-nowrap animate-marquee flex gap-8">
          {news.length > 0 ? news.map(n => (
            <span 
              key={n.id} 
              onClick={() => setNewsModal(n)} // Klik untuk buka modal
              className="text-xs font-bold text-blue-300 uppercase tracking-widest cursor-pointer hover:text-white transition"
            >
              ★ {n.title}
            </span>
          )) : <span className="text-xs text-gray-500">Belum ada berita terbaru...</span>}
        </div>
      </div>

      {/* Modal Berita */}
      {newsModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm" onClick={()=>setNewsModal(null)}>
          <div className="glass-panel p-6 rounded-2xl max-w-sm w-full animate-fade-in" onClick={e=>e.stopPropagation()}>
            <h3 className="font-bold text-xl text-blue-400 mb-2 font-display">{newsModal.title}</h3>
            <div className="h-1 w-12 bg-blue-500 rounded mb-4"></div>
            <p className="text-sm text-gray-300 leading-relaxed whitespace-pre-wrap">{newsModal.content}</p>
            <button onClick={()=>setNewsModal(null)} className="mt-6 w-full bg-white/10 py-2 rounded-lg text-xs font-bold">TUTUP</button>
          </div>
        </div>
      )}

      {/* Game Selection */}
      {!selectedGame ? (
        <div className="px-4 mt-6">
          <h2 className="text-sm font-bold text-gray-400 mb-3 flex items-center gap-2">
            <Icon name="check" size={16} className="text-green-500"/> PILIH GAME
          </h2>
          <div className="grid grid-cols-2 gap-3">
            {[
              {id: 'ff', title: 'Free Fire', img: 'https://images.unsplash.com/photo-1628151016665-27663d91c781?w=400&auto=format&fit=crop&q=60'}, 
              {id: 'ml', title: 'Mobile Legends', img: 'https://images.unsplash.com/photo-1542751371-adc38448a05e?w=400&auto=format&fit=crop&q=60'}
            ].map(g => (
              <div key={g.id} onClick={()=>setSelectedGame(g)} className="glass-panel rounded-xl overflow-hidden cursor-pointer hover:border-blue-500/50 transition group">
                <div className="h-24 overflow-hidden">
                  <img src={g.img} className="w-full h-full object-cover group-hover:scale-110 transition duration-500"/>
                </div>
                <div className="p-3 text-center">
                  <div className="font-bold text-sm">{g.title}</div>
                </div>
              </div>
            ))}
          </div>
        </div>
      ) : (
        /* Checkout View */
        <div className="px-4 mt-4 animate-fade-in">
          <button onClick={()=>{setSelectedGame(null); setSelectedItem(null); setAppliedPromo(null);}} className="mb-4 text-xs flex items-center gap-1 text-gray-400 hover:text-white">
            <Icon name="chevronLeft" size={16}/> Kembali
          </button>
          
          <div className="glass-panel p-4 rounded-xl mb-4 border-t-4 border-t-blue-500">
            <h2 className="font-display font-bold text-xl mb-4 uppercase">{selectedGame.title}</h2>
            <div className="space-y-3">
              <input value={form.uid} onChange={e=>setForm({...form, uid:e.target.value})} type="number" placeholder="User ID" className="glass-input w-full p-3 rounded-lg font-bold text-sm"/>
              {selectedGame.id === 'ml' && <input value={form.zone} onChange={e=>setForm({...form, zone:e.target.value})} type="number" placeholder="Zone ID" className="glass-input w-full p-3 rounded-lg font-bold text-sm"/>}
              <input value={form.nick} onChange={e=>setForm({...form, nick:e.target.value})} placeholder="Nickname" className="glass-input w-full p-3 rounded-lg font-bold text-sm"/>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-2 mb-4">
            {products.filter(p => p.gameId === selectedGame.id).map(p => (
              <button key={p.id} onClick={()=>setSelectedItem(p)} className={`p-3 rounded-xl border text-left transition ${selectedItem?.id===p.id ? 'bg-blue-600 border-blue-400' : 'glass-panel border-white/5 hover:bg-white/5'}`}>
                <div className="text-xs font-bold mb-1">{p.name}</div>
                <div className="text-sm font-display">Rp {p.price.toLocaleString()}</div>
              </button>
            ))}
          </div>

          {selectedItem && (
            <div className="glass-panel p-4 rounded-xl mb-20 animate-fade-in">
              <div className="text-xs font-bold text-gray-400 mb-2">KODE PROMO</div>
              <div className="flex gap-2 mb-4">
                <input 
                  value={form.promo} 
                  onChange={e=>setForm({...form, promo: e.target.value})} 
                  placeholder="Masukkan Kode" 
                  className="glass-input flex-1 p-2 rounded-lg text-xs uppercase font-bold"
                />
                <button onClick={checkPromo} className="bg-purple-600 px-4 rounded-lg font-bold text-xs">CEK</button>
              </div>
              
              <div className="border-t border-white/10 pt-3 space-y-1">
                <div className="flex justify-between text-xs text-gray-400">
                  <span>Harga</span>
                  <span>Rp {selectedItem.price.toLocaleString()}</span>
                </div>
                {appliedPromo && (
                   <div className="flex justify-between text-xs text-green-400 font-bold">
                    <span>Diskon ({appliedPromo.code})</span>
                    <span>- Rp {appliedPromo.discount.toLocaleString()}</span>
                  </div>
                )}
                <div className="flex justify-between text-lg font-bold mt-2">
                  <span>Total</span>
                  <span className="text-blue-400">
                    Rp {Math.max(0, appliedPromo ? (selectedItem.price - appliedPromo.discount) : selectedItem.price).toLocaleString()}
                  </span>
                </div>
              </div>
              <button onClick={handleOrder} className="w-full bg-blue-600 py-3 rounded-xl font-bold mt-4 shadow-lg shadow-blue-900/50">
                BAYAR SEKARANG
              </button>
            </div>
          )}
        </div>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
